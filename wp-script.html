<script>

var blank = document.querySelectorAll("#menu-sociaux a");

for(var i = 0; i < blank.length; i++){
	blank[i].setAttribute("target", "_blank");
}

/* Suppression d'éléments Wordpress superflus */
document.getElementsByClassName('hero')[0].remove();

	
var test = document.getElementById("photo");
if (test!=null) {
	var viewer = new PANOLENS.Viewer( { 
		container: document.querySelector( '#container' ),
		controlBar: false,
		cameraFov: 100,
		autoHideInfospot: false
	});
	var panorama = new PANOLENS.ImagePanorama( 'https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/cafepetitpont-scaled.jpg' );
	viewer.add(panorama);
    var page_photo = document.getElementById("photo");
    document.getElementById("photo").style.display = "none";
}
	
$(function() {
	var test_container = document.querySelector( '#container' );
	if (test_container!=null) {
		/* Lieux et coordonnées */
		var cafePetitPont = {
			lat: 48.853270474173044,
			lng: 2.34680141570036,
			name: "cafepetitpont",
			p1: "05/paita_cafepetitpont",
			p2: "04/usk_cafepetitpont-scaled",
			coord1: '-5000.00,-2783.94,-4862.44'
		};
		var egliseStMedard = {
			lat: 48.8391589455749, 
			lng: 2.3500561311743415,
			name: "eglisestmedard",
			p1: "05/paita_eglisestmedard",
			p2: "04/usk_eglisestmedard-scaled",
			coord1: '-5000.00,-1256.98,228.08'
		};
		var grandPalais = {
			lat: 48.86301398465097,
			lng: 2.316530563411216,
			name: "grandpalais",
			p1: "05/paita_grandpalais-",
			p2: "05/paita_grandpalais-",
			coord1: '-1107.60,-1665.17,-5000.00'
		};
		var louvrePyramides = {
			lat: 48.86169896524472, 
			lng: 2.334681288707981,
			name: "louvrepyramides",
			p1: "05/paita_louvrepyramides",
			p2: "04/usk_louvrepyramides-scaled",
			coord1: '-3943.73,-1223.26,5000.00'
		};
		var notreDame = {
			lat: 48.850875729772405,
			lng: 2.35321546195698,
			name: "notredame",
			p1: "05/paita_notredame",
			p2: "05/paita_notredame",
			coord1: '-5000.00,-1242.11,-859.25'
		};
		var palaisRoyal = {
			lat: 48.863943879149794,
			lng: 2.3372070138226446,
			name: "palaisroyal",
			p1: "05/paita_palaisroyal",
			p2: "04/usk_palaisroyal-scaled",
			coord1: '-227.29,-2272.87,-5000.00'
		};
		var placeDauphine = {
			lat: 48.856547916788955,
			lng: 2.342509436915052,
			name: "placedauphine",
			p1: "05/paita_placedauphine",
			p2: "04/usk_placedauphine-scaled",
			coord1: '207.45,-596.13,-5000.00'
		};
		var placeFurstenberg = {
			lat: 48.85431991590883,
			lng: 2.3357365589945087,
			name: "placefurstenberg",
			p1: "05/paita_placefurstenberg",
			p2: "04/usk_placefurstenberg-scaled",
			coord1: '-681.86,-538.75,-5000.00'
		};
		var pontArcheveche = {
			lat: 48.85136661386947,
			lng: 2.3514503864678886,
			name: "pontarcheveche",
			p1: "05/paita_pontarchevecher",
			p2: "04/usk_pontarcheveche-scaled",
			coord1: '-5000.00,-1240.55,-986.87'
		};
		var pontMarie = {
			lat: 48.852287536067706,
			lng: 2.357639259582509,
			name: "pontmarie",
			p1: "05/paita_pontmarie",
			p2: "04/usk_pontmarie-scaled",
			coord1: '-5000.00,-2036.73,737.83'
		};
		var pontNeuf = {
			lat: 48.85839361258938, 
			lng: 2.337610053471593,
			name: "pontneuf",
			p1: "05/paita_pontneuf1",
			p11: "05/paita_pontneuf2",
			p2: "04/usk_pontneuf-scaled",
			coord1: '-844.92,-2372.25,-5000.00',
			coord2: '2020.08,-2728.97,-5000.00'
		};
		var sullyMorland = {
			lat: 48.85072087893228, 
			lng: 2.3613934134141923,
			name: "sullymorland",
			p1: "05/paita_sullymorland",
			p2: "04/usk_sullymorland",
			coord1: '5000.00,-3191.08,680.43'
		};

		if ($(window).width() > 480) {
			var map = L.map("map", {
				center: [48.85214995518537, 2.3400600567994783],
				zoom: 14
			});
		} else {
			var map = L.map("map", {
				center: [48.85818299537591, 2.3401020332948073],
				zoom: 13
			});
		}
		
		// Fonction qui définit l'action au clic sur un marqueur.
		function waypointClick(e) {
			if (e._latlng.lat == cafePetitPont.lat && e._latlng.lng == cafePetitPont.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[8].setIcon(redIcon);
				}
				photo360(cafePetitPont);

			} else if (e._latlng.lat == grandPalais.lat && e._latlng.lng == grandPalais.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					console.log(map._layers);
					les_points[2].setIcon(redIcon);
				}
				photo360(grandPalais);

			} else if (e._latlng.lat == egliseStMedard.lat && e._latlng.lng == egliseStMedard.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
				}
				photo360(egliseStMedard);
				
			} else if (e._latlng.lat == louvrePyramides.lat && e._latlng.lng == louvrePyramides.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[4].setIcon(redIcon);
				}
				photo360(louvrePyramides);
				
			} else if (e._latlng.lat == notreDame.lat && e._latlng.lng == notreDame.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {	
					e.setIcon(blueIcon);
					les_points[9].setIcon(redIcon);
				}
				photo360(notreDame);

			} else if (e._latlng.lat == palaisRoyal.lat && e._latlng.lng == palaisRoyal.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[3].setIcon(redIcon);
				}
				photo360(palaisRoyal);
				
			} else if (e._latlng.lat == placeDauphine.lat && e._latlng.lng == placeDauphine.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[7].setIcon(redIcon);
				}
				photo360(placeDauphine);

			} else if (e._latlng.lat == placeFurstenberg.lat && e._latlng.lng == placeFurstenberg.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[6].setIcon(redIcon);
				}
				photo360(placeFurstenberg);

			} else if (e._latlng.lat == pontArcheveche.lat && e._latlng.lng == pontArcheveche.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[10].setIcon(redIcon);
				}
				photo360(pontArcheveche);

			} else if (e._latlng.lat == pontMarie.lat && e._latlng.lng == pontMarie.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[11].setIcon(redIcon);
				}
				photo360(pontMarie);
				
			} else if (e._latlng.lat == pontNeuf.lat && e._latlng.lng == pontNeuf.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[5].setIcon(redIcon);
				}
				photo360(pontNeuf);

			} else if (e._latlng.lat == sullyMorland.lat && e._latlng.lng == sullyMorland.lng) {
				document.getElementById("map").style.display = "none";
				page_photo.style.display = "block";
				if (e.options.icon.options.iconUrl == "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png") {
					e.setIcon(blueIcon);
					les_points[12].setIcon(redIcon);
				}
				photo360(sullyMorland);
			}
		}

		// Attributions obligatoires pour la carte.
		L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
		attribution:
			'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
		}).addTo(map);

		// Ajout des marqueurs
		var redIcon = L.icon({
			iconUrl: 'https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/red-icon.png',
			iconSize:     [25, 41], // size of the icon
			iconAnchor:   [15, 40], // point of the icon which will correspond to marker's location
			popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
		}); 
		var blueIcon = L.icon({
			iconUrl: 'https://unpkg.com/leaflet@1.0.0/dist/images/marker-icon.png',
			iconSize:     [25, 41], // size of the icon
			iconAnchor:   [15, 40], // point of the icon which will correspond to marker's location
			popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
		}); 
		
		var markers = L.marker([grandPalais.lat, grandPalais.lng], {icon: redIcon, title: "Grand Palais"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([palaisRoyal.lat, palaisRoyal.lng], {icon: blueIcon, title: "Palais-Royal"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([louvrePyramides.lat, louvrePyramides.lng], {icon: blueIcon, title: "Pyramide du Louvre"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([pontNeuf.lat, pontNeuf.lng], {icon: blueIcon, title: "Pont Neuf"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([placeFurstenberg.lat, placeFurstenberg.lng], {icon: blueIcon, title: "Place de Furstemberg"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([placeDauphine.lat, placeDauphine.lng], {icon: blueIcon, title: "Place Dauphine"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([cafePetitPont.lat, cafePetitPont.lng], {icon: blueIcon, title: "Café le Petit Pont"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([notreDame.lat, notreDame.lng], {icon: blueIcon, title: "Cathédrale Notre-Dame de Paris"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([pontArcheveche.lat, pontArcheveche.lng], {icon: blueIcon, title: "Pont de l'Archevêché"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([pontMarie.lat, pontMarie.lng], {icon: blueIcon, title: "Pont Marie"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([sullyMorland.lat, sullyMorland.lng], {icon: blueIcon, title: "Sully-Morland"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		markers = L.marker([egliseStMedard.lat, egliseStMedard.lng], {icon: blueIcon, title: "Église Saint-Médard"}).addTo(map).on('click', function() {
			waypointClick(this);
		});
		
		var les_points = [];
		for (point in map._layers) {
			les_points.push(map._layers[point]);
		}
	}
})
// Fonction qui définit l'action du bouton "retour", i.e. faire revenir la carte.
function retourClick(viewer, panorama) {  
	page_photo.style.display = "none";
	document.getElementById("map").style.display = "block";
}	
	
/* Photo 360 */
function photo360(lieu) {
	var x, y, z, xyz;
    var container = document.querySelector( '#container' );
	xyz = lieu.coord1.split(',');
	x = parseFloat(xyz[0]);
	y = parseFloat(xyz[1]);
	z = parseFloat(xyz[2]);
	
	viewer.remove(panorama);
	panorama = new PANOLENS.ImagePanorama( 'https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/'+lieu.name+'-scaled.jpg' );
	var infospot = new PANOLENS.Infospot( 1000, 'https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/hotspot.png' );
	infospot.position.set( x, y, z );
	$(function() {
		infospot.addEventListener('click', function(event) {
			$('#lightbox').modal('show');
			
		});	
		$('.item').eq(0).children('img').eq(0).attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/"+lieu.p1+".jpg");
		$('.item').eq(1).children('img').eq(0).attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/"+lieu.p2+".jpg");
		
	})

	panorama.add( infospot );
	
	if (lieu.name == "pontneuf") {
		xyz = lieu.coord2.split(',');
		x = parseFloat(xyz[0]);
		y = parseFloat(xyz[1]);
		z = parseFloat(xyz[2]);
		var infospot2 = new PANOLENS.Infospot( 1000, 'https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/hotspot.png' );
		
		$(function() {
			infospot2.addEventListener('click', function(event) {
				$('#lightbox2').modal('show');	
			});	

			$('.item').eq(2).children('img').eq(0).attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/"+lieu.p11+".jpg");
			$('.item').eq(3).children('img').eq(0).attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/"+lieu.p2+".jpg");
		});
		infospot2.position.set( x, y, z );
		panorama.add( infospot2 );
	}
	
	$(function() {
		var help = $('.help')[0];
		if ($(window).width() <= 480) {
			$('#helpmodal-img').attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/aide_navigation_portrait.jpg")
		} else {
			$('#helpmodal-img').attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/aide_navigation_paysage.jpg")
		}
		$(window).on("resize", function () {
			if ($(window).width() <= 480) {
				$('#helpmodal-img').attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/aide_navigation_portrait.jpg")
			} else {
				$('#helpmodal-img').attr("src", "https://wordpress.gwenaellepont.fr/wp-content/uploads/2021/04/aide_navigation_paysage.jpg")
			}
		});
		
		help.addEventListener('click', function(event) {
			$('#helpmodal').modal('show');
		});
		
		function centerModal() {
			$(this).css('display', 'block');
			var $dialog = $(this).find(".modal-dialog");
			if ($(window).width() > 880) {
				var offset = ($(window).height() - $dialog.height()) / 2;
				var width = ($(window).width() + 250  - $dialog.width()) / 2;
			} else {
				var offset = ($(window).height() + $('#masthead').height() - $dialog.height()) / 2;
				var width = ($(window).width() - $dialog.width()) / 2;
			}
			
			// Center modal vertically in window
			$dialog.css("margin-top", offset);
			$dialog.css("margin-left", width);
		}
		
		$('.modal').on('show.bs.modal', centerModal);
		$(window).on("resize", function () {
			$('.modal:visible').each(centerModal);
		});
		
		$('.carousel').each(function(){
			$(this).carousel({
				wrap: false,
				interval: false
			});
		});

		var left = $('.left');
		var right = $('.right');
		var left2 = $('.left2');
		var right2 = $('.right2');
		var pop1 = $('.pop-1');
		var pop2 = $('.pop-2');

		left.css({'display': 'none'});
		right.css({'display': 'flex'});
		left2.css({'display': 'none'});
		right2.css({'display': 'flex'});

		left.click(previous);
		right.click(next);
		left2.click(previous);
		right2.click(next);

		function previous() {
			for (var i=0; i<pop1.length; i++) {
				if ("active" == pop1[i].className.split(" ")[1] || "active" == pop1[i].className.split(" ")[2]) {
					if (typeof pop1[i-2] != "undefined" && typeof pop1[i-1] != "undefined") {
						left.css({'display': 'flex'});
						right.css({'display': 'flex'});
					} else {
						left.css({'display': 'none'});
						right.css({'display': 'flex'});
					}
				}
				if ("active" == pop2[i].className.split(" ")[1] || "active" == pop2[i].className.split(" ")[2]) {
					if (typeof pop2[i-2] != "undefined" && typeof pop2[i-1] != "undefined") {
						left.css({'display': 'flex'});
						right.css({'display': 'flex'});
					} else {
						left.css({'display': 'none'});
						right.css({'display': 'flex'});
					}
				}
			}
		}

		function next() {
			for (var i=0; i<pop1.length; i++) {
				if ("active" == pop1[i].className.split(" ")[1] || "active" == pop1[i].className.split(" ")[2]) {
					if (typeof pop1[i+1] != "undefined" && typeof pop1[i+2] != "undefined") {
						left.css({'display': 'flex'});
						right.css({'display': 'flex'});
					} else {
						left.css({'display': 'flex'});
						right.css({'display': 'none'});
					}
				}
				if ("active" == pop2[i].className.split(" ")[1] || "active" == pop2[i].className.split(" ")[2]) {
					if (typeof pop2[i+1] != "undefined" && typeof pop2[i+2] != "undefined") {
						left.css({'display': 'flex'});
						right.css({'display': 'flex'});
					} else {
						left.css({'display': 'flex'});
						right.css({'display': 'none'});
					}
				}
			}
		}
		
		$('#lightbox').on("hidden.bs.modal", function() {
			console.log('quit');
			var firstItem = $(this).find(".item:first");
			if ( !firstItem.hasClass("active") ) {
			  $(this).find(".active").removeClass("active");
			  firstItem.addClass("active");
        	}
			left.css({'display': 'none'});
			right.css({'display': 'flex'});
		});
		
		if (lieu.name == 'pontneuf') {
			$('#lightbox2').on("hidden.bs.modal", function() {
				console.log('quit');
				var firstItem = $(this).find(".item:first");
				if ( !firstItem.hasClass("active") ) {
				  $(this).find(".active").removeClass("active");
				  firstItem.addClass("active");
				}
				left.css({'display': 'none'});
				right.css({'display': 'flex'});
			});
		}
	})
	
	viewer.OrbitControls.noZoom = true;
    viewer.add( panorama );
	viewer.setPanorama( panorama );
	
	var ROTATION_POSITION = 0.04;
	var ROTATION_SPEED = 1000;
	
	function moveL(){
		let go = ROTATION_POSITION;
		let back = - ROTATION_POSITION;
		let pos  = 1 < 1 ? go : back;
		let easing = {val : pos};
		let tween = new TWEEN.Tween(easing) 
			.to({val: 0}, ROTATION_SPEED)
			.easing(TWEEN.Easing.Quadratic.InOut) 
			.onUpdate(function(event) { 
				TWEEN.update(1000);
				viewer.OrbitControls.rotateLeft(easing.val);
			}).start();
	}
	function moveR(){
		let go = ROTATION_POSITION;
		let back = - ROTATION_POSITION;
		let pos  = 0 < 1 ? go : back;
		let easing = {val : pos};
		let tween = new TWEEN.Tween(easing) 
			.to({val: 0}, ROTATION_SPEED) 
			.easing(TWEEN.Easing.Quadratic.InOut) 
			.onUpdate(function() { 
				viewer.OrbitControls.rotateLeft(easing.val);
		}).start();
	}
	
	var gauche = document.getElementsByClassName('gauche')[0];
	var droite = document.getElementsByClassName('droite')[0];
	gauche.onclick = moveL;
	droite.onclick = moveR;
	
	var retour = document.getElementById("retour");
    retour.addEventListener('click', function(event) {
		retourClick(viewer, panorama);
	});
}
</script>